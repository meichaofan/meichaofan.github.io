<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  

  
  <title>huany</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="一如当年">
<meta property="og:type" content="website">
<meta property="og:title" content="huany">
<meta property="og:url" content="https://meichaofan.github.io/index.html">
<meta property="og:site_name" content="huany">
<meta property="og:description" content="一如当年">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="huany">
<meta name="twitter:description" content="一如当年">
  
    <link rel="alternate" href="/atom.xml" title="huany" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">huany</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/categories">Categories</a>
        
          <a class="main-nav-link" href="/categories/tec">Tec</a>
        
          <a class="main-nav-link" href="/categories/read-note">ReadNote</a>
        
          <a class="main-nav-link" href="/categories/life">Life</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://meichaofan.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-install-k8s" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/08/26/install-k8s/" class="article-date">
  <time datetime="2019-08-26T12:41:43.000Z" itemprop="datePublished">2019-08-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/08/26/install-k8s/">利用kubeadm安装k8s</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><h3 id="主机配置和角色分配"><a href="#主机配置和角色分配" class="headerlink" title="主机配置和角色分配"></a>主机配置和角色分配</h3><table>
<thead>
<tr>
<th>ip</th>
<th>host</th>
<th>角色</th>
<th>配置</th>
</tr>
</thead>
<tbody>
<tr>
<td>192.168.136.130</td>
<td>master.huany.com</td>
<td>master</td>
<td>CentOS 7.6</td>
</tr>
<tr>
<td>192.168.136.131</td>
<td>node1.huany.com</td>
<td>node1</td>
<td>CentOS 7.6</td>
</tr>
<tr>
<td>192.168.136.132</td>
<td>node2.huany.com</td>
<td>node2</td>
<td>CentOS 7.6</td>
</tr>
</tbody>
</table>
<h2 id="预先设置"><a href="#预先设置" class="headerlink" title="预先设置"></a>预先设置</h2><h3 id="关闭swap"><a href="#关闭swap" class="headerlink" title="关闭swap"></a>关闭swap</h3><ul>
<li>临时关闭，运行：<code>swapoff -a</code>，下次启动还有</li>
<li>到/etc/fstab中永久删除或关闭swap分区，使用 # 注释掉即可。</li>
</ul>
<h3 id="关闭和清理ufw"><a href="#关闭和清理ufw" class="headerlink" title="关闭和清理ufw"></a>关闭和清理ufw</h3><p>下面的命令将清除现有的所有防火墙规则：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ iptables -F</span><br></pre></td></tr></table></figure></p>
<h3 id="设置cgroups"><a href="#设置cgroups" class="headerlink" title="设置cgroups"></a>设置cgroups</h3><p>确保kubelet使用的cgroup driver与 Docker的一致。要么使用下面的方法更新 Docker：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt; EOF &gt; /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></p>
<p>要么，设置kubernetes的cgroup driver，如：kubelet 的 –cgroup-driver 标志设置为与 Docker 一样(e.g. cgroupfs)。</p>
<h2 id="安装master节点"><a href="#安装master节点" class="headerlink" title="安装master节点"></a>安装master节点</h2><h3 id="修改内核配置"><a href="#修改内核配置" class="headerlink" title="修改内核配置"></a>修改内核配置</h3><ul>
<li><p>编辑 /etc/sysctl.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">net.ipv6.conf.all.disable_ipv6 = 1</span><br><span class="line">net.ipv6.conf.default.disable_ipv6 = 1</span><br><span class="line">net.ipv6.conf.lo.disable_ipv6 = 1</span><br><span class="line">vm.swappiness = 0</span><br><span class="line">net.ipv4.neigh.default.gc_stale_time = 120</span><br><span class="line">net.ipv4.conf.all.rp_filter = 0</span><br><span class="line">net.ipv4.conf.default.rp_filter = 0</span><br><span class="line">net.ipv4.conf.default.arp_announce = 2</span><br><span class="line">net.ipv4.conf.lo.arp_announce = 2</span><br><span class="line">net.ipv4.conf.all.arp_announce = 2</span><br><span class="line">net.ipv4.tcp_max_tw_buckets = 5000</span><br><span class="line">net.ipv4.tcp_syncookies = 1</span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 1024</span><br><span class="line">net.ipv4.tcp_synack_retries = 2</span><br><span class="line">kernel.sysrq = 1</span><br><span class="line">net.ipv4.tcp_tw_reuse = 1</span><br><span class="line">net.ipv4.ip_local_port_range = 1024 65023</span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 10240</span><br><span class="line">net.ipv4.tcp_max_tw_buckets = 400000</span><br><span class="line">net.ipv4.tcp_max_orphans = 60000</span><br><span class="line">net.ipv4.tcp_synack_retries = 3</span><br><span class="line">net.core.somaxconn = 10000</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">vm.swappiness = 0</span><br></pre></td></tr></table></figure>
</li>
<li><p>然后执行<code>sysctl -p</code>使修改生效</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sysctl -p</span><br></pre></td></tr></table></figure>
<h3 id="安装docker环境"><a href="#安装docker环境" class="headerlink" title="安装docker环境"></a>安装docker环境</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">1. SET UP THE REPOSITORY</span><br><span class="line"></span><br><span class="line">$ sudo yum install -y yum-utils \</span><br><span class="line">  device-mapper-persistent-data \</span><br><span class="line">  lvm2</span><br><span class="line"></span><br><span class="line">$ sudo yum-config-manager \</span><br><span class="line">    --add-repo \</span><br><span class="line">    https://download.docker.com/linux/centos/docker-ce.repo</span><br><span class="line"></span><br><span class="line">2. INSTALL DOCKER ENGINE - COMMUNITY</span><br><span class="line"></span><br><span class="line">$ yum list docker-ce --showduplicates | sort -r</span><br><span class="line"></span><br><span class="line">docker-ce.x86_64  3:18.09.1-3.el7                     docker-ce-stable</span><br><span class="line">docker-ce.x86_64  3:18.09.0-3.el7                     docker-ce-stable</span><br><span class="line">docker-ce.x86_64  18.06.1.ce-3.el7                    docker-ce-stable</span><br><span class="line">docker-ce.x86_64  18.06.0.ce-3.el7                    docker-ce-stable</span><br><span class="line"></span><br><span class="line">安装18.06.0.ce-3版本</span><br><span class="line">sudo yum install docker-ce-18.06.0.ce-3.e17 docker-ce-cli-18.06.0.ce-3.el7 containerd.io</span><br><span class="line"></span><br><span class="line">3. RUN DOCKER</span><br><span class="line"></span><br><span class="line">$ sudo systemctl start docker</span><br></pre></td></tr></table></figure>
<h3 id="安装配置kubeadm"><a href="#安装配置kubeadm" class="headerlink" title="安装配置kubeadm"></a>安装配置kubeadm</h3><ul>
<li>配置阿里云的kubernetes镜像仓库</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">$ yum makecache fast</span><br></pre></td></tr></table></figure>
<ul>
<li>安装kubeadm cni 等工具</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install -y kubernetes-cni kubelet kubeadm kubectl --skip-broken</span><br><span class="line">systemctl start kubelet.service</span><br><span class="line">systemctl enable kubelet.service</span><br></pre></td></tr></table></figure>
<p><strong>默认情况下这里的kubeadm kubectl kubelet默认安装的都是最新版本</strong></p>
<ul>
<li>配置CNI网络配置</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">mkdir /etc/cni/net.d/ -p</span><br><span class="line">$ cat &gt;/etc/cni/net.d/10-mynet.conf &lt;&lt;-EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;cniVersion&quot;: &quot;0.3.0&quot;,</span><br><span class="line">    &quot;name&quot;: &quot;mynet&quot;,</span><br><span class="line">    &quot;type&quot;: &quot;bridge&quot;,</span><br><span class="line">    &quot;bridge&quot;: &quot;cni0&quot;,</span><br><span class="line">    &quot;isGateway&quot;: true,</span><br><span class="line">    &quot;ipMasq&quot;: true,</span><br><span class="line">    &quot;ipam&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;host-local&quot;,</span><br><span class="line">        &quot;subnet&quot;: &quot;10.244.0.0/16&quot;,</span><br><span class="line">        &quot;routes&quot;: [</span><br><span class="line">            &#123;&quot;dst&quot;: &quot;0.0.0.0/0&quot;&#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">$ cat &gt;/etc/cni/net.d/99-loopback.conf &lt;&lt;-EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;cniVersion&quot;: &quot;0.3.0&quot;,</span><br><span class="line">    &quot;type&quot;: &quot;loopback&quot;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<ul>
<li>配置kubeadm的配置文件</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">kind: MasterConfiguration</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1alpha2</span><br><span class="line">#kubernetesVersion: &quot;stable&quot;</span><br><span class="line">kubernetesVersion: &quot;v1.15.3&quot;</span><br><span class="line">apiServerCertSANs: []</span><br><span class="line">#imageRepository: crproxy.trafficmanager.net:6000/google_containers</span><br><span class="line">#imageRepository: mirrorgooglecontainers</span><br><span class="line">imageRepository: registry.aliyuncs.com/google_containers</span><br><span class="line">#imageRepository: &quot;&quot;</span><br><span class="line">controllerManagerExtraArgs:</span><br><span class="line">  horizontal-pod-autoscaler-use-rest-clients: &quot;true&quot;</span><br><span class="line">  horizontal-pod-autoscaler-sync-period: &quot;10s&quot;</span><br><span class="line">  node-monitor-grace-period: &quot;10s&quot;</span><br><span class="line">  feature-gates: &quot;AllAlpha=true&quot;</span><br><span class="line">  enable-dynamic-provisioning: &quot;true&quot;</span><br><span class="line">apiServerExtraArgs:</span><br><span class="line">  runtime-config: &quot;api/all=true&quot;</span><br><span class="line">  feature-gates: &quot;AllAlpha=true&quot;</span><br><span class="line">  #feature-gates: &quot;CoreDNS=true&quot;</span><br><span class="line">networking:</span><br><span class="line">  podSubnet: &quot;10.244.0.0/16&quot;</span><br></pre></td></tr></table></figure>
<ul>
<li>拉取镜像</li>
</ul>
<p>脚本如下，如果需要其它的容器镜像可以照此增加即可，可以将版本号修改为自己需要的。</p>
<ul>
<li>注意：kubernetes每个版本依赖的版本不同，下面适用1.15.3。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;==================================================&quot;</span><br><span class="line">echo &quot;Pulling Docker Images from registry.aliyuncs.com...&quot;</span><br><span class="line"></span><br><span class="line">echo &quot;==&gt;kube-apiserver:&quot;</span><br><span class="line">docker pull registry.aliyuncs.com/google_containers/kube-apiserver:v1.15.3</span><br><span class="line">docker tag registry.aliyuncs.com/google_containers/kube-apiserver:v1.15.3 k8s.gcr.io/kube-apiserver:v1.15.3</span><br><span class="line"></span><br><span class="line">echo &quot;==&gt;kube-controller-manager:&quot;</span><br><span class="line">docker pull registry.aliyuncs.com/google_containers/kube-controller-manager:v1.15.3</span><br><span class="line">docker tag registry.aliyuncs.com/google_containers/kube-controller-manager:v1.15.3 k8s.gcr.io/kube-controller-manager:v1.15.3</span><br><span class="line"></span><br><span class="line">echo &quot;==&gt;kube-scheduler:&quot;</span><br><span class="line">docker pull registry.aliyuncs.com/google_containers/kube-scheduler:v1.15.3 </span><br><span class="line">docker tag registry.aliyuncs.com/google_containers/kube-scheduler:v1.15.3 k8s.gcr.io/kube-scheduler:v1.15.3</span><br><span class="line"></span><br><span class="line">echo &quot;==&gt;kube-proxy:&quot;</span><br><span class="line">docker pull registry.aliyuncs.com/google_containers/kube-proxy:v1.15.3</span><br><span class="line">docker tag registry.aliyuncs.com/google_containers/kube-proxy:v1.15.3 k8s.gcr.io/kube-proxy:v1.15.3</span><br><span class="line"></span><br><span class="line">echo &quot;==&gt;k8s-dns-kube-dns:&quot;</span><br><span class="line">docker pull registry.aliyuncs.com/google_containers/coredns:1.3.1</span><br><span class="line">docker tag registry.aliyuncs.com/google_containers/coredns:1.3.1 k8s.gcr.io/coredns:1.3.1</span><br><span class="line"></span><br><span class="line">echo &quot;==&gt;etcd:&quot;</span><br><span class="line">docker pull registry.aliyuncs.com/google_containers/etcd:3.3.10</span><br><span class="line">docker tag registry.aliyuncs.com/google_containers/etcd:3.3.10 k8s.gcr.io/etcd:3.3.10</span><br><span class="line"></span><br><span class="line">echo &quot;==&gt;pause:&quot;</span><br><span class="line">docker pull registry.aliyuncs.com/google_containers/pause:3.1</span><br><span class="line">docker tag registry.aliyuncs.com/google_containers/pause:3.1 k8s.gcr.io/pause:3.1</span><br><span class="line"></span><br><span class="line">echo finished.</span><br><span class="line">echo &quot;you are so lucy&quot;</span><br></pre></td></tr></table></figure>
<ul>
<li>初始化</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubeadm init --config kubeadm.yml --pod-network-cidr 10.244.0.0/16 -ignore-preflight-errors all</span><br></pre></td></tr></table></figure>
<p>执行成功后可以看到如下内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Your Kubernetes control-plane has initialized successfully!</span><br><span class="line"></span><br><span class="line">To start using your cluster, you need to run the following as a regular user:</span><br><span class="line"></span><br><span class="line">  mkdir -p $HOME/.kube</span><br><span class="line">  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">  sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br><span class="line"></span><br><span class="line">You should now deploy a pod network to the cluster.</span><br><span class="line">Run &quot;kubectl apply -f [podnetwork].yaml&quot; with one of the options listed at:</span><br><span class="line">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class="line"></span><br><span class="line">Then you can join any number of worker nodes by running the following on each as root:</span><br><span class="line"></span><br><span class="line">kubeadm join 192.168.136.130:6443 --token 32ozhx.8xneb9rzjukjc3au \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:00c3d4e272d3736c0edcfcdda38f255c9fb75118a7d640a3e98542829f4bb3ec</span><br></pre></td></tr></table></figure>
<ul>
<li>切换到普通用户执行</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p $HOME/.kube</span><br><span class="line">sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br></pre></td></tr></table></figure>
<ul>
<li>查看节点</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get nodes</span><br><span class="line">NAME               STATUS   ROLES    AGE    VERSION</span><br><span class="line">master.huany.com   NotReady    master   2d3h   v1.15.3</span><br></pre></td></tr></table></figure>
<p>如果重启或者kubeadm reset 将清理掉cni配置，需要重新配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">mkdir /etc/cni/net.d/ -p</span><br><span class="line">cat &gt;/etc/cni/net.d/10-mynet.conf &lt;&lt;-EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;cniVersion&quot;: &quot;0.3.0&quot;,</span><br><span class="line">    &quot;name&quot;: &quot;mynet&quot;,</span><br><span class="line">    &quot;type&quot;: &quot;bridge&quot;,</span><br><span class="line">    &quot;bridge&quot;: &quot;cni0&quot;,</span><br><span class="line">    &quot;isGateway&quot;: true,</span><br><span class="line">    &quot;ipMasq&quot;: true,</span><br><span class="line">    &quot;ipam&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;host-local&quot;,</span><br><span class="line">        &quot;subnet&quot;: &quot;10.244.0.0/16&quot;,</span><br><span class="line">        &quot;routes&quot;: [</span><br><span class="line">            &#123;&quot;dst&quot;: &quot;0.0.0.0/0&quot;&#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">cat &gt;/etc/cni/net.d/99-loopback.conf &lt;&lt;-EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;cniVersion&quot;: &quot;0.3.0&quot;,</span><br><span class="line">    &quot;type&quot;: &quot;loopback&quot;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>查看节点情况</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get nodes</span><br><span class="line">NAME               STATUS   ROLES    AGE    VERSION</span><br><span class="line">master.huany.com   Ready    master   2d3h   v1.15.3</span><br></pre></td></tr></table></figure>
<h2 id="在node节点上安装"><a href="#在node节点上安装" class="headerlink" title="在node节点上安装"></a>在node节点上安装</h2><p>同上，修改Linux内核，安装docker，安装kubeadm </p>
<ul>
<li><p>加入到集群中去</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubeadm join 192.168.136.130:6443 --token 32ozhx.8xneb9rzjukjc3au \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:00c3d4e272d3736c0edcfcdda38f255c9fb75118a7d640a3e98542829f4bb3ec</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置cni网络</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">mkdir /etc/cni/net.d/ -p</span><br><span class="line">cat &gt;/etc/cni/net.d/10-mynet.conf &lt;&lt;-EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;cniVersion&quot;: &quot;0.3.0&quot;,</span><br><span class="line">    &quot;name&quot;: &quot;mynet&quot;,</span><br><span class="line">    &quot;type&quot;: &quot;bridge&quot;,</span><br><span class="line">    &quot;bridge&quot;: &quot;cni0&quot;,</span><br><span class="line">    &quot;isGateway&quot;: true,</span><br><span class="line">    &quot;ipMasq&quot;: true,</span><br><span class="line">    &quot;ipam&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;host-local&quot;,</span><br><span class="line">        &quot;subnet&quot;: &quot;10.244.0.0/16&quot;,</span><br><span class="line">        &quot;routes&quot;: [</span><br><span class="line">            &#123;&quot;dst&quot;: &quot;0.0.0.0/0&quot;&#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">cat &gt;/etc/cni/net.d/99-loopback.conf &lt;&lt;-EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;cniVersion&quot;: &quot;0.3.0&quot;,</span><br><span class="line">    &quot;type&quot;: &quot;loopback&quot;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<h3 id="在master上查看节点情况："><a href="#在master上查看节点情况：" class="headerlink" title="在master上查看节点情况："></a>在master上查看节点情况：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[meichaofan@master keights]$ kubectl get nodes</span><br><span class="line">NAME               STATUS   ROLES    AGE    VERSION</span><br><span class="line">master.huany.com   Ready    master   2d3h   v1.15.3</span><br><span class="line">node1.huany.com    Ready    &lt;none&gt;   2d3h   v1.15.3</span><br><span class="line">node2.huany.com    Ready    &lt;none&gt;   2d3h   v1.15.3</span><br></pre></td></tr></table></figure>
<ul>
<li>在master附属flannel网络</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/v0.10.0/Documentation/kube-flannel.yml</span><br></pre></td></tr></table></figure>
<ul>
<li>查看运行的服务</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[meichaofan@master keights]$ kubectl get pods -n kube-system</span><br><span class="line">NAME                                       READY   STATUS             RESTARTS   AGE</span><br><span class="line">coredns-5c98db65d4-mc25l                   1/1     Running            17         7h18m</span><br><span class="line">coredns-5c98db65d4-p7mtp                   1/1     Running            16         7h19m</span><br><span class="line">etcd-master.huany.com                      1/1     Running            2          2d3h</span><br><span class="line">kube-apiserver-master.huany.com            1/1     Running            2          2d3h</span><br><span class="line">kube-controller-manager-master.huany.com   0/1     CrashLoopBackOff   22         2d3h</span><br><span class="line">kube-flannel-ds-8l7jc                      1/1     Running            0          2d3h</span><br><span class="line">kube-flannel-ds-l952q                      1/1     Running            2          2d3h</span><br><span class="line">kube-flannel-ds-qmfgk                      1/1     Running            0          2d3h</span><br><span class="line">kube-proxy-b2r8g                           1/1     Running            3          2d3h</span><br><span class="line">kube-proxy-ccdr4                           1/1     Running            0          2d3h</span><br><span class="line">kube-proxy-klp8f                           1/1     Running            0          2d3h</span><br><span class="line">kube-scheduler-master.huany.com            1/1     Running            17         2d3</span><br></pre></td></tr></table></figure>
<h3 id="在node上拉取pause、kubeproxy容器，并转换tag"><a href="#在node上拉取pause、kubeproxy容器，并转换tag" class="headerlink" title="在node上拉取pause、kubeproxy容器，并转换tag"></a>在node上拉取pause、kubeproxy容器，并转换tag</h3><ul>
<li>node1<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># pause</span><br><span class="line">docker pull registry.aliyuncs.com/google_containers/pause:3.1</span><br><span class="line">docker tag registry.aliyuncs.com/google_containers/pause:3.1 k8s.gcr.io/pause:3.1</span><br><span class="line"></span><br><span class="line"># kube-proxy</span><br><span class="line">docker pull registry.aliyuncs.com/google_containers/kube-proxy:v1.15.3</span><br><span class="line">docker tag registry.aliyuncs.com/google_containers/kube-proxy:v1.15.3 k8s.gcr.io/kube-proxy:v1.15.3</span><br></pre></td></tr></table></figure>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://meichaofan.github.io/2019/08/26/install-k8s/" data-id="ckghavx2b0021bad81d19gaqg" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/docker/">docker</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/k8s/">k8s</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-linux-json-format" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/08/02/linux-json-format/" class="article-date">
  <time datetime="2019-08-02T15:42:12.000Z" itemprop="datePublished">2019-08-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/08/02/linux-json-format/">linux下json解析神器 - jq</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="jq"><a href="#jq" class="headerlink" title="jq"></a>jq</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">jq - commandline JSON processor [version 1.6]</span><br><span class="line"></span><br><span class="line">Usage:  jq [options] &lt;jq filter&gt; [file...]</span><br><span class="line">    jq [options] --args &lt;jq filter&gt; [strings...]</span><br><span class="line">    jq [options] --jsonargs &lt;jq filter&gt; [JSON_TEXTS...]</span><br><span class="line"></span><br><span class="line">jq is a tool for processing JSON inputs, applying the given filter to</span><br><span class="line">its JSON text inputs and producing the filter&apos;s results as JSON on</span><br><span class="line">standard output.</span><br><span class="line"></span><br><span class="line">The simplest filter is ., which copies jq&apos;s input to its output</span><br><span class="line">unmodified (except for formatting, but note that IEEE754 is used</span><br><span class="line">for number representation internally, with all that that implies).</span><br><span class="line"></span><br><span class="line">For more advanced filters see the jq(1) manpage (&quot;man jq&quot;)</span><br><span class="line">and/or https://stedolan.github.io/jq</span><br><span class="line"></span><br><span class="line">Example:</span><br><span class="line"></span><br><span class="line">    $ echo &apos;&#123;&quot;foo&quot;: 0&#125;&apos; | jq .</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;foo&quot;: 0</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">For a listing of options, use jq --help.</span><br></pre></td></tr></table></figure>
<h3 id="jf"><a href="#jf" class="headerlink" title="jf"></a>jf</h3><p>改写成 shell 脚本执行模式<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line">argsCount=$#</span><br><span class="line">if [ $argsCount -ne 1 ];then</span><br><span class="line">    echo &quot;Usage : jf json_str&quot;</span><br><span class="line">    exit 2</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">jsonStr=$1</span><br><span class="line"></span><br><span class="line">echo $&#123;jsonStr&#125; | /usr/local/bin/jq .</span><br></pre></td></tr></table></figure></p>
<p>执行方法是：<code>jf &#39;{&quot;name&quot;:&quot;meichaofan&quot;}&#39;</code></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://meichaofan.github.io/2019/08/02/linux-json-format/" data-id="ckghavx2h002cbad84yt69lyo" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-printf-console-color" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/08/01/printf-console-color/" class="article-date">
  <time datetime="2019-08-01T14:27:36.000Z" itemprop="datePublished">2019-08-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/08/01/printf-console-color/">设定printf在终端输出字体的颜色</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>终端字符的颜色是用转义序列进行控制，是文本模式下的系统显示功能，和具体的语言无关。转义序列是以 ESC 开头,可以用 \033 完成相同的工作（ESC 的 ASCII 码用十进制表示就是 27， = 用八进制表示的 33）。</p>
<h3 id="格式"><a href="#格式" class="headerlink" title="格式"></a>格式</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\033[显示方式；前景色；背景色m</span><br></pre></td></tr></table></figure>
<p>1) 显示方式：0（默认值）、1（高亮）、22（非粗体）、4（下划线）、24（非下划线）、5（闪烁）、25（非闪烁）、7（反显）、27（非反显）</p>
<p>2) 前景色：30（黑色）、31（红色）、32（绿色）、 33（黄色）、34（蓝色）、35（洋红）、36（青色）、37（白色）</p>
<p>3) 背景色：40（黑色）、41（红色）、42（绿色）、 43（黄色）、44（蓝色）、45（洋红）、46（青色）、47（白色）</p>
<h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><p>1）默认颜色：\033[0m，也是关闭所有属性<br>　<br>2）绿色：\033[1;32;40m<br>　<br>3）红色：\033[1;31;40m</p>
<p>4）printf( “\033[1;31;40m 输出红色字符 \033[0m” )</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://meichaofan.github.io/2019/08/01/printf-console-color/" data-id="ckghavx2n002mbad8xxrr8mxg" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/printf/">printf</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-clion-create-multi-project" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/31/clion-create-multi-project/" class="article-date">
  <time datetime="2019-07-31T15:42:39.000Z" itemprop="datePublished">2019-07-31</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/31/clion-create-multi-project/">clion建立多级工作目录</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>之前对Clion不熟悉，每次写项目都在主目录下，导致一个主目录只能写一个main函数，下面学习如何在CLion建立多级工程目录</p>
<hr>
<h3 id="操作："><a href="#操作：" class="headerlink" title="操作："></a>操作：</h3><p>在主工作目录下，有一个CMakeList.txt文件，内容如下：</p>
<p><img src="http://image.huany.top/hexo/c/clion-main-cmakelist.png" alt></p>
<p>其中，<code>ADD_SUBDIRECTORY(function-point)</code>，这个是代表包含子目录的意思。</p>
<p>对于子目录<code>function-point</code>,也必须有一个CMakeList.txt文件，指定子目录中的可执行文件。</p>
<p><img src="http://image.huany.top/hexo/c/clion-sub-makelist.png" alt></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://meichaofan.github.io/2019/07/31/clion-create-multi-project/" data-id="ckghavx0y000xbad87i9z6alm" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/c/">c</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-sword-finger-offer-3-1" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/26/sword-finger-offer-3-1/" class="article-date">
  <time datetime="2019-07-26T15:10:17.000Z" itemprop="datePublished">2019-07-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/26/sword-finger-offer-3-1/">剑指Offer - 3.1 - 数组中重复的数字</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>在一个长度为n的数组里的所有数字都是0~n-1的范围内。数组中某些数字都是重复的，但不知道有几个数字重复了，也不知道每个数字重复了几次。请找出数组中任意一个重复的数字。例如，如果输入长度为7的数组{2,3,1,0,2,5,3}，那么对应的输出是重复的数字2或者3.</p>
<hr>
<h4 id="解题思路"><a href="#解题思路" class="headerlink" title="解题思路"></a>解题思路</h4><p>我们注意到数组中的数字都在0~n-1的范围内。如果这个数组中没有重复的数字，那么当数字排序之后数字i将出现在下标为i的位置。由于数组中有重复的数字，有些位置可能存在多个数字，同时有些位置可能没有数字。</p>
<h4 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"sort"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">n个数， 0~n-1之间，找出有重复的数字</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">//1.排序</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getDuplicateNum1</span><span class="params">(numbers []<span class="keyword">int</span>)</span> []<span class="title">int</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> ret []<span class="keyword">int</span></span><br><span class="line">    i := <span class="number">0</span></span><br><span class="line">    length := <span class="built_in">len</span>(numbers)</span><br><span class="line">    sort.Ints(numbers)</span><br><span class="line">    <span class="keyword">for</span> i &lt; length<span class="number">-1</span> &#123;</span><br><span class="line">        <span class="comment">//fmt.Printf("i: %d\n", i)</span></span><br><span class="line">        <span class="keyword">if</span> numbers[i] == numbers[i+<span class="number">1</span>] &#123;</span><br><span class="line">            ret = <span class="built_in">append</span>(ret, numbers[i])</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> i &lt; length<span class="number">-1</span> &amp;&amp; numbers[i] == numbers[i+<span class="number">1</span>] &#123;</span><br><span class="line">            i++</span><br><span class="line">        &#125;</span><br><span class="line">        i++</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//2.借助map(hashtable)</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getDuplicateNum2</span><span class="params">(numbers []<span class="keyword">int</span>)</span> []<span class="title">int</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> ret []<span class="keyword">int</span></span><br><span class="line">    tmp := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">int</span>)</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(numbers); i++ &#123;</span><br><span class="line">        <span class="keyword">if</span> count, ok := tmp[numbers[i]]; ok &#123;</span><br><span class="line">            tmp[numbers[i]] = count + <span class="number">1</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            tmp[numbers[i]] = <span class="number">1</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> k, v := <span class="keyword">range</span> tmp &#123;</span><br><span class="line">        <span class="keyword">if</span> v &gt; <span class="number">1</span> &#123;</span><br><span class="line">            ret = <span class="built_in">append</span>(ret, k)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//巧妙3：数组内自排序，时间复杂度0(n) , 空间复杂度是 O(1)</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getDuplicateNum3</span><span class="params">(numbers []<span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">    length := <span class="built_in">len</span>(numbers)</span><br><span class="line">    i := <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i &lt; length &#123;</span><br><span class="line">        <span class="keyword">for</span> i != numbers[i] &#123;</span><br><span class="line">            <span class="keyword">if</span> numbers[i] == numbers[numbers[i]] &amp;&amp; i != numbers[i] &#123;</span><br><span class="line">                <span class="keyword">return</span> numbers[i]</span><br><span class="line">            &#125;</span><br><span class="line">            numbers[i], numbers[numbers[i]] = numbers[numbers[i]], numbers[i]</span><br><span class="line">        &#125;</span><br><span class="line">        i++</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> length</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    numbers := []<span class="keyword">int</span>&#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">5</span>&#125;</span><br><span class="line">    ret1 := getDuplicateNum1(numbers)</span><br><span class="line">    fmt.Printf(<span class="string">"%v\n"</span>, ret1)</span><br><span class="line"></span><br><span class="line">    numbers = []<span class="keyword">int</span>&#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">5</span>&#125;</span><br><span class="line">    ret2 := getDuplicateNum2(numbers)</span><br><span class="line">    fmt.Printf(<span class="string">"%v\n"</span>, ret2)</span><br><span class="line"></span><br><span class="line">    numbers = []<span class="keyword">int</span>&#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">5</span>&#125;</span><br><span class="line">    ret3 := getDuplicateNum3(numbers)</span><br><span class="line">    fmt.Printf(<span class="string">"%v\n"</span>, ret3)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://meichaofan.github.io/2019/07/26/sword-finger-offer-3-1/" data-id="ckghavx2r002rbad8joi6fji8" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-go-sync-Once" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/26/go-sync-Once/" class="article-date">
  <time datetime="2019-07-25T16:30:27.000Z" itemprop="datePublished">2019-07-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/26/go-sync-Once/">go sync.Once</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><code>sync.Once</code> 可以实现单例模式，确保<code>sync.Once.Do(f func())</code>只会被执行一次，可以初始化某个实例单例。</p>
<p>sync.Once表示只执行一次的函数。要做到这一点，就需要以下两点要求：</p>
<ul>
<li>计数器，统计函数执行的次数</li>
<li>线程安全，保障在多G情况下，函数仍然只执行一次，比如锁。即对计时器的修改是线性安全的。</li>
</ul>
<h3 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h3><p>下面是sync.Once源码，源码不长，但值得分析</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">package sync</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">    &quot;sync/atomic&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">// Once is an object that will perform exactly one action.</span><br><span class="line">type Once struct &#123;</span><br><span class="line">    m    Mutex</span><br><span class="line">    done uint32</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (o *Once) Do(f func()) &#123;</span><br><span class="line">    if atomic.LoadUint32(&amp;o.done) == 1 &#123;</span><br><span class="line">        return</span><br><span class="line">    &#125;</span><br><span class="line">    // Slow-path.</span><br><span class="line">    o.m.Lock()</span><br><span class="line">    defer o.m.Unlock()</span><br><span class="line">    if o.done == 0 &#123;</span><br><span class="line">        defer atomic.StoreUint32(&amp;o.done, 1)</span><br><span class="line">        f()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Once结构体证明了之前的猜想，果然有两个变量。</strong></p>
<p>Do方法相对简单，但是也是也可以学习的地方。</p>
<ul>
<li>1.原子操作判断o.done是否为1，若为1，表示f已经执行过，直接返回</li>
<li>2.加锁，保证互斥访问</li>
<li>3.若o.done为0，表示f未执行，执行f函数，对o.done原子赋值。</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://meichaofan.github.io/2019/07/26/go-sync-Once/" data-id="ckghavx1v001nbad8jo263zw9" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/go/">go</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-c-函数指针" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/26/c-函数指针/" class="article-date">
  <time datetime="2019-07-25T16:10:42.000Z" itemprop="datePublished">2019-07-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/26/c-函数指针/">c 函数指针</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h3><p>首先，先不要把指向函数的指针认为太难了，它和普通的指针区别不是很大，只是定义形式上有所区别。</p>
<p>比如，对于一个指向整形的普通指针，定义形式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int *p;</span><br></pre></td></tr></table></figure>
<p>在定义中，指针变量的名称是p，符号<code>*</code>说明了p是一个指针，int说明这个指针指向的是整形变量。</p>
<p>那么，如果我们定义一个指向函数的指针，假设变量名称为p，比如它指向这样的一个函数，这个函数需要两个整数参数，其返回值也是整形参数，其定义如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int (*p)(int int);</span><br></pre></td></tr></table></figure>
<p>对于这个定义分解一下，其中，p是变量的名称，符号<code>*</code>说明了p是一个指针，由于这个指针指向的是一个函数，所以在定义中必须体现函数的输入输出参数信息，那么最前面的int指的就是函数的返回值为int类型，后面的(int,int)则定义了该函数需要两个整形的输入参数。另外，必须将<code>*</code>与<code>p</code>用括号写成<code>(*p)</code>的形式，否则，由于括号的优先级大于<code>*</code>的优先级，去掉括号的话就成为另外一种意思了。</p>
<p>这样对比着理解，指向函数的指针，似乎与普通指针区别也不是太大。</p>
<h3 id="指向函数指针例子"><a href="#指向函数指针例子" class="headerlink" title="指向函数指针例子"></a>指向函数指针例子</h3><p>下面通过一个例子演示指向函数的指针的使用方法。</p>
<p>该例子的功能是，对于一个输入的一维数组，定义三个函数findMax、findMin和getAvg，分别实现查找该数组的最大值、最小值及计算该数组的平均值，这三个函数的输入输出参数完全相同。定义一个fun函数，在该函数的参数中，需要一个指针变量作参数，这个指针能够指向上面的三个函数。在主程序中，调用fun函数，根据传入不同的p值实现对输入的一维数组作不同的处理功能。</p>
<p>下面先看下几部分的实现代码吧。</p>
<h4 id="findMax、findMin和getAvg代码实现"><a href="#findMax、findMin和getAvg代码实现" class="headerlink" title="findMax、findMin和getAvg代码实现"></a>findMax、findMin和getAvg代码实现</h4><p>这三个函数对一维数组x，分别作求最大值、最小值及平均值的处理，并将其结果返回。C语言代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">double findMax(double *x, int n) &#123;</span><br><span class="line">    double max = x[0];</span><br><span class="line">    for (int i = 1; i &lt; n; ++i) &#123;</span><br><span class="line">        if (max &lt; x[i]) max = x[i];</span><br><span class="line">    &#125;</span><br><span class="line">    return max;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">double findMin(double *x, int n) &#123;</span><br><span class="line">    double min = x[0];</span><br><span class="line">    for (int i = 1; i &lt; n; ++i) &#123;</span><br><span class="line">        if (min &gt; x[i]) min = x[i];</span><br><span class="line">    &#125;</span><br><span class="line">    return min;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">double getAvg(double *x, int n) &#123;</span><br><span class="line">    double sum = 0;</span><br><span class="line">    for (int i = 0; i &lt; n; ++i) &#123;</span><br><span class="line">        sum += x[i];</span><br><span class="line">    &#125;</span><br><span class="line">    return sum / n;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这三个函数比较简单，函数原型完全一样，输入参数为一个指向double的指针x及x的元素个数n，输出参数也就是返回值是一个double型的数值。</p>
<h4 id="fun函数的代码实现"><a href="#fun函数的代码实现" class="headerlink" title="fun函数的代码实现"></a>fun函数的代码实现</h4><p>该函数输入参数为3个，前两个为指向double的指针x及x的元素个数n，第三个为一个指向函数的指针类型，这个指针能够指向上面的三个函数。C语言代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">double fun(double *x, int n, double (*p)(double *, int)) &#123;</span><br><span class="line">    return p(x, n);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那么，在主程序中可以调用该函数，只要输入不同的p值，就可以对输入的一维数组作不同的处理运算。</p>
<h4 id="主程序测试代码"><a href="#主程序测试代码" class="headerlink" title="主程序测试代码"></a>主程序测试代码</h4><p>主程序测试代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">void mian(void)</span><br><span class="line">&#123;</span><br><span class="line">    double x[5] = &#123;1.1, 3.4, 4.5, 1.3, 5.6&#125;;</span><br><span class="line">    fun(x, 5, findMax);</span><br><span class="line">    fun(x, 5, findMin);</span><br><span class="line">    fun(x, 5, getAvg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="笨方法学C例子"><a href="#笨方法学C例子" class="headerlink" title="笨方法学C例子"></a>笨方法学C例子</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">#include &lt;errno.h&gt;</span><br><span class="line">#include &lt;string.h&gt;</span><br><span class="line"></span><br><span class="line">void die(const char *message) &#123;</span><br><span class="line">    if (errno) &#123;</span><br><span class="line">        perror(message);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        printf(&quot;Error : %s\n&quot;, message);</span><br><span class="line">    &#125;</span><br><span class="line">    exit(1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">typedef int (*compare_cb)(int a, int b);</span><br><span class="line"></span><br><span class="line">int *bubble_sort(int *numbers, int count, compare_cb cmp) &#123;</span><br><span class="line">    int temp = 0;</span><br><span class="line">    int i = 0;</span><br><span class="line">    int j = 0;</span><br><span class="line">    int *target = malloc(count * sizeof(int));</span><br><span class="line"></span><br><span class="line">    if (!target) die(&quot;Memory error.&quot;);</span><br><span class="line"></span><br><span class="line">    memcpy(target, numbers, count * sizeof(int));</span><br><span class="line"></span><br><span class="line">    for (i = 0; i &lt; count; ++i) &#123;</span><br><span class="line">        for (j = 0; j &lt; count - 1; ++j) &#123;</span><br><span class="line">            if (cmp(target[j], target[j + 1]) &gt; 0) &#123;</span><br><span class="line">                temp = target[j + 1];</span><br><span class="line">                target[j + 1] = target[j];</span><br><span class="line">                target[j] = temp;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return target;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int sorted_order(int a, int b) &#123;</span><br><span class="line">    return a - b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int reverse_order(int a, int b) &#123;</span><br><span class="line">    return b - a;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int strange_order(int a, int b) &#123;</span><br><span class="line">    if (a == 0 || b == 0) &#123;</span><br><span class="line">        return 0;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        return a % b;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void test_sorting(int *numbers, int count, compare_cb cmp) &#123;</span><br><span class="line">    int i = 0;</span><br><span class="line">    int *sorted = bubble_sort(numbers, count, cmp);</span><br><span class="line">    if (!sorted) die(&quot;Failed to sort as request.&quot;);</span><br><span class="line">    for (i = 0; i &lt; count; i++) &#123;</span><br><span class="line">        printf(&quot;%d &quot;, sorted[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    printf(&quot;\n&quot;);</span><br><span class="line">    free(sorted);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main(int argc, char *argv[]) &#123;</span><br><span class="line">    if (argc &lt; 2) die(&quot;Usage: ext 4 3 1 5 6&quot;);</span><br><span class="line">    int count = argc - 1;</span><br><span class="line">    int i = 0;</span><br><span class="line">    char **inputs = argv + 1;</span><br><span class="line"></span><br><span class="line">    int *numbers = malloc(count * sizeof(int));</span><br><span class="line">    if (!numbers) die(&quot;Memory error.&quot;);</span><br><span class="line"></span><br><span class="line">    for (i = 0; i &lt; count; ++i) &#123;</span><br><span class="line">        numbers[i] = atoi(inputs[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    test_sorting(numbers, count, sorted_order);</span><br><span class="line">    test_sorting(numbers, count, reverse_order);</span><br><span class="line">    test_sorting(numbers, count, strange_order);</span><br><span class="line"></span><br><span class="line">    free(numbers);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://meichaofan.github.io/2019/07/26/c-函数指针/" data-id="ckghavx0m000kbad87bss9hmm" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/c/">c</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-go-waitgroup" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/22/go-waitgroup/" class="article-date">
  <time datetime="2019-07-22T15:22:39.000Z" itemprop="datePublished">2019-07-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/22/go-waitgroup/">go waitgroup</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>WaitGroup是Go应用开发过程中经常使用的并发控制技术。</p>
<p>WaitGroup，可理解为Wait-Groutine-Group，即等待一组goroutine结束。比如某个goroutine需要等待其他几个goroutine全部完成，那么使用WaitGroup可以轻松实现。</p>
<p>下面程序展示了一个goroutine等待另外两个goroutine结束的例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">    &quot;fmt&quot;</span><br><span class="line">    &quot;time&quot;</span><br><span class="line">    &quot;sync&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">    var wg sync.WaitGroup</span><br><span class="line"></span><br><span class="line">    wg.Add(2) //设置计数器，数值即为goroutine的个数</span><br><span class="line">    go func() &#123;</span><br><span class="line">        //Do some work</span><br><span class="line">        time.Sleep(1*time.Second)</span><br><span class="line"></span><br><span class="line">        fmt.Println(&quot;Goroutine 1 finished!&quot;)</span><br><span class="line">        wg.Done() //goroutine执行结束后将计数器减1</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    go func() &#123;</span><br><span class="line">        //Do some work</span><br><span class="line">        time.Sleep(2*time.Second)</span><br><span class="line"></span><br><span class="line">        fmt.Println(&quot;Goroutine 2 finished!&quot;)</span><br><span class="line">        wg.Done() //goroutine执行结束后将计数器减1</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    wg.Wait() //主goroutine阻塞等待计数器变为0</span><br><span class="line">    fmt.Printf(&quot;All Goroutine finished!&quot;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>简单的说，上面程序中wg内部维护了一个计数器：</p>
<ul>
<li>1.启动goroutine前将计数器通过Add(2)将计数器设置为待启动的goroutine个数。</li>
<li>2.启动goroutine后，使用Wait()方法阻塞自己，等待计数器变为0。 </li>
<li>3.每个goroutine执行结束通过Done()方法将计数器减1。</li>
<li>4.计数器变为0后，阻塞的goroutine被唤醒。</li>
</ul>
<h3 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h3><h4 id="信号量"><a href="#信号量" class="headerlink" title="信号量"></a>信号量</h4><p>信号量是Unix系统提供的一种保护共享资源的机制，用于防止多个线程同时访问某个资源。</p>
<p>可简单理解为信号量为一个数值：</p>
<ul>
<li>当信号量&gt;0时，表示资源可用，获取信号量时系统自动将信号量减1；</li>
<li>当信号量==0时，表示资源暂不可用，获取信号量时，当前线程会进入睡眠，当信号量为正时被唤醒；</li>
</ul>
<p>WaitGroup视线中也使用了信号量</p>
<h3 id="WaitGroup"><a href="#WaitGroup" class="headerlink" title="WaitGroup"></a>WaitGroup</h3><h4 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h4><p>源码包中<code>src/sync/waitgroup.go:WaitGroup</code>定义了其数据结构：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">type WaitGroup struct &#123;</span><br><span class="line">    state1 [3]uint32</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>state1是个长度为3的数组，其中包含了state和一个信号量，而state实际上是两个计数器：</p>
<ul>
<li>counter：当前还未执行结束的goroutine计数器</li>
<li>waiter count：等待goroutine-group结束的goroutine数量，即有多少个等候者</li>
<li>semaphore：信号量</li>
</ul>
<p>考虑到字节是否对齐，三者出现的位置不同，为简单起见，依照字节已对齐情况下，三者在内存中的位置如下所示：</p>
<p><img src="http://image.huany.top/hexo/go/wg-01-layout.png" alt></p>
<p>WaitGroup对外提供了3个接口：</p>
<ul>
<li>Add(delta int): 将delta值加到counter中</li>
<li>Wait()： waiter递增1，并阻塞等待信号量semaphore</li>
<li>Done()： counter递减1，当counter=0时按照waiter数值释放相应次数信号量</li>
</ul>
<p>下面分别介绍这三个函数的实现细节。</p>
<h4 id="Add-delta-int"><a href="#Add-delta-int" class="headerlink" title="Add(delta int)"></a>Add(delta int)</h4><p>Add()做了两件事，一是把delta值累加到counter中，因为delta可以为负值，也就是说counter有可能变成0或负值，所以第二件事就是当counter值变为0时，跟据waiter数值释放等量的信号量，把等待的goroutine全部唤醒，如果counter变为负值，则panic.</p>
<p>Add()伪代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">func (wg *WaitGroup) Add(delta int) &#123;</span><br><span class="line">    statep, semap := wg.state() //获取state和semaphore地址指针</span><br><span class="line"></span><br><span class="line">    state := atomic.AddUint64(statep, uint64(delta)&lt;&lt;32) //把delta左移32位累加到state，即累加到counter中</span><br><span class="line">    v := int32(state &gt;&gt; 32) //获取counter值</span><br><span class="line">    w := uint32(state)      //获取waiter值</span><br><span class="line"></span><br><span class="line">    if v &lt; 0 &#123;              //经过累加后counter值变为负值，panic</span><br><span class="line">        panic(&quot;sync: negative WaitGroup counter&quot;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //经过累加后，此时，counter &gt;= 0</span><br><span class="line">    //如果counter为正，说明不需要释放信号量，直接退出</span><br><span class="line">    //如果waiter为零，说明没有等待者，也不需要释放信号量，直接退出</span><br><span class="line">    if v &gt; 0 || w == 0 &#123;</span><br><span class="line">        return</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //此时，counter一定等于0，而waiter一定大于0（内部维护waiter，不会出现小于0的情况），</span><br><span class="line">    //先把counter置为0，再释放waiter个数的信号量</span><br><span class="line">    *statep = 0</span><br><span class="line">    for ; w != 0; w-- &#123;</span><br><span class="line">        runtime_Semrelease(semap, false) //释放信号量，执行一次释放一个，唤醒一个等待者</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Wait"><a href="#Wait" class="headerlink" title="Wait()"></a>Wait()</h4><p>Wait()方法也做了两件事，一是累加waiter, 二是阻塞等待信号量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">func (wg *WaitGroup) Wait() &#123;</span><br><span class="line">    statep, semap := wg.state() //获取state和semaphore地址指针</span><br><span class="line">    for &#123;</span><br><span class="line">        state := atomic.LoadUint64(statep) //获取state值</span><br><span class="line">        v := int32(state &gt;&gt; 32)            //获取counter值</span><br><span class="line">        w := uint32(state)                 //获取waiter值</span><br><span class="line">        if v == 0 &#123;                        //如果counter值为0，说明所有goroutine都退出了，不需要待待，直接返回</span><br><span class="line">            return</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 使用CAS（比较交换算法）累加waiter，累加可能会失败，失败后通过for loop下次重试</span><br><span class="line">        if atomic.CompareAndSwapUint64(statep, state, state+1) &#123;</span><br><span class="line">            runtime_Semacquire(semap) //累加成功后，等待信号量唤醒自己</span><br><span class="line">            return</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里用到了CAS算法保证有多个goroutine同时执行Wait()时也能正确累加waiter。</p>
<h4 id="Done"><a href="#Done" class="headerlink" title="Done()"></a>Done()</h4><p>Done()只做一件事，即把counter减1，我们知道Add()可以接受负值，所以Done实际上只是调用了Add(-1)。</p>
<p>源码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">func (wg *WaitGroup) Done() &#123;</span><br><span class="line">    wg.Add(-1)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Done()的执行逻辑就转到了Add()，实际上也正是最后一个完成的goroutine把等待者唤醒的。</p>
<h3 id="编程Tips"><a href="#编程Tips" class="headerlink" title="编程Tips"></a>编程Tips</h3><ul>
<li>Add() 操作必须早于Wait，否则会panic</li>
<li>Add()设置的值必须与实际等待的goroutine个数一致，否则会panic</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://meichaofan.github.io/2019/07/22/go-waitgroup/" data-id="ckghavx21001rbad8qw1fnviw" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Go/">Go</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-c-char-array" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/20/c-char-array/" class="article-date">
  <time datetime="2019-07-19T16:56:02.000Z" itemprop="datePublished">2019-07-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/20/c-char-array/">c语言 - 字符数组和字符串</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h4 id="字符数组定义"><a href="#字符数组定义" class="headerlink" title="字符数组定义"></a>字符数组定义</h4><p>用来存放字符的数组成为字符数组，例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">char a[20] = &#123;&apos;c&apos;, &apos; &apos;, &apos;p&apos;, &apos;r&apos;, &apos;o&apos;, &apos;g&apos;, &apos;r&apos;, &apos;a&apos;,&apos;m&apos;&#125;; //给部分数组元素赋值</span><br><span class="line">char b[] = &#123;&apos;c&apos;, &apos; &apos;, &apos;p&apos;, &apos;r&apos;, &apos;o&apos;, &apos;g&apos;, &apos;r&apos;, &apos;a&apos;,&apos;m&apos;&#125;; //对全体元素赋值可以省去长度</span><br></pre></td></tr></table></figure>
<p>字符数组实际上是一些列字符的集合，也就是字符串（string）。在C语言中，没有专门的字符串变量，没有string类型，通常就用一个字符数组来存放一个字符串。</p>
<h4 id="字符数组和字符串赋值"><a href="#字符数组和字符串赋值" class="headerlink" title="字符数组和字符串赋值"></a>字符数组和字符串赋值</h4><p>C语言规定，可以将字符串直接赋值给字符数组，例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">char str[30] = &#123;&quot;c.biancheng.net&quot;&#125;;</span><br><span class="line">char str[30] = &quot;c.biancheng.net&quot;; //这种形式更加简洁，实际开发中常用</span><br></pre></td></tr></table></figure>
<p>数组第0个元素为 ‘c’，第1个元素为 ‘.’，第2个元素为 ‘b’，后面的元素以此类推。也可以不指定数组长度，例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">char str[] = &#123;&quot;c.biancheng.net&quot;&#125;;</span><br><span class="line">char str[] = &quot;c.biancheng.net&quot;; //这种形式更加简洁，实际开发中常用</span><br></pre></td></tr></table></figure>
<p>在C语言中，字符串总是以<code>&#39;\0&#39;</code>作为串的结束符。上面的两个字符串，编译器已经在末尾自动添加了<code>&#39;\0&#39;</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&apos;\0&apos;是ASCII码表中的第0个字符，用NUL表示，称为空字符。该字符既不能显示，也不是控制字符，输出该字符不会有任何效果，它在C语言中仅作为字符串的结束标志。</span><br></pre></td></tr></table></figure>
<p><code>puts</code>和<code>printf</code>函数在输出字符串时会逐个扫描字符，直到遇见<code>\0</code>才结束输出。请看下面的例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line"></span><br><span class="line">int main() &#123;</span><br><span class="line">    int i;</span><br><span class="line">    char str1[30] = &quot;http://c.biancheng.net&quot;;</span><br><span class="line">    char str2[] = &quot;C Language&quot;;</span><br><span class="line">    char str3[30] = &quot;You are a good\0 boy!&quot;;</span><br><span class="line">    printf(&quot;str1: %s\n&quot;, str1);</span><br><span class="line">    printf(&quot;str2: %s\n&quot;, str2);</span><br><span class="line">    printf(&quot;str3: %s\n&quot;, str3);</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">str1: http://c.biancheng.net</span><br><span class="line">str2: C Language</span><br><span class="line">str3: You are a good</span><br></pre></td></tr></table></figure>
<p>str1 和 str2 很好理解，编译器会在字符串最后自动添加 ‘\0’，并且数组足够大，所以会输出整个字符串。对于 str3，由于字符串中间存在 ‘\0’，printf() 扫描到这里就认为字符串结束了，所以不会输出后面的内容。</p>
<h4 id="字符数组和字符串区别"><a href="#字符数组和字符串区别" class="headerlink" title="字符数组和字符串区别"></a>字符数组和字符串区别</h4><p>需要注意的是，用字符串给字符数组赋值时由于要添加结束符 ‘\0’，数组的长度要比字符串的长度（字符串长度不包括 ‘\0’）大1。例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">char str[] = &quot;C program&quot;;</span><br></pre></td></tr></table></figure>
<p>该数组在内存中实际存放情况为：</p>
<p><img src="http://image.huany.top/hexo/c/sfdsgfsge.png" alt></p>
<p><strong>字符串长度为 9，数组长度为 10。</strong></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://meichaofan.github.io/2019/07/20/c-char-array/" data-id="ckghavx0p000nbad8wguwwglf" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/C/">C</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-php-array" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/13/php-array/" class="article-date">
  <time datetime="2019-07-12T17:44:35.000Z" itemprop="datePublished">2019-07-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/13/php-array/">php array</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h2><p>PHP数组的低层实现为散列表（HashTable,也称作：哈希表）。除了我们熟悉的PHP用户空间的Array类型之外，内核中也随处用到了散列表，比如函数，类，常量，已include文件的索引表，全局符号表等都用HashTable存储。</p>
<p>散列表是根据关键码值(Key value)而直接进行访问的数据结构，它的key - value之间存在一个映射函数，可以根据key通过映射函数直接索引到对应的value值，它不以关键字的比较为基本操作，<strong>采用直接寻址技术</strong>（就是说，它是直接通过key映射到内存地址上去的），从而加快查找速度，在理想情况下，无须任何比较就可以找到待查关键字，查找的期望时间为O(1)。</p>
<h3 id="1-数组结构"><a href="#1-数组结构" class="headerlink" title="1.数组结构"></a>1.数组结构</h3><p>存放记录的数组称作散列表，这个数组用来存储value。而value具体在数组中的存储位置，由映射函数根据key计算确定，映射函数可以采用取模的方式，key可以通过一些譬如“times 33”的算法得到一个整形值，然后与数组总大小取模得到在散列表中的存储位置。这是一个普通散列表的实现，PHP散列表的实现整体也是这个思路。<br>下面是PHP中HashTable的数据结构</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Bucket：散列表中存储的元素</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">Bucket</span> &#123;</span></span><br><span class="line">    zval              val; <span class="comment">//存储的具体value，这里嵌入了一个zval，而不是一个指针</span></span><br><span class="line">    zend_ulong        h;   <span class="comment">//key根据times 33计算得到的哈希值，或者是数值索引编号</span></span><br><span class="line">    zend_string      *key; <span class="comment">//存储元素的key</span></span><br><span class="line">&#125; Bucket;</span><br><span class="line"></span><br><span class="line"><span class="comment">//HashTable结构</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">zend_array</span> <span class="title">HashTable</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">zend_array</span> &#123;</span></span><br><span class="line">    zend_refcounted_h gc;</span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">            ZEND_ENDIAN_LOHI_4(</span><br><span class="line">                    zend_uchar    flags,</span><br><span class="line">                    zend_uchar    nApplyCount,</span><br><span class="line">                    zend_uchar    nIteratorsCount,</span><br><span class="line">                    zend_uchar    reserve)</span><br><span class="line">        &#125; v;</span><br><span class="line">        <span class="keyword">uint32_t</span> flags;</span><br><span class="line">    &#125; u;</span><br><span class="line">    <span class="keyword">uint32_t</span>          nTableMask; <span class="comment">//哈希值计算掩码，等于nTableSize的负值(nTableMask = -nTableSize)</span></span><br><span class="line">    Bucket           *arData;     <span class="comment">//存储元素数组，指向第一个Bucket</span></span><br><span class="line">    <span class="keyword">uint32_t</span>          nNumUsed;   <span class="comment">//已用Bucket数</span></span><br><span class="line">    <span class="keyword">uint32_t</span>          nNumOfElements; <span class="comment">//哈希表有效元素数</span></span><br><span class="line">    <span class="keyword">uint32_t</span>          nTableSize;     <span class="comment">//哈希表总大小，为2的n次方</span></span><br><span class="line">    <span class="keyword">uint32_t</span>          nInternalPointer;</span><br><span class="line">    zend_long         nNextFreeElement; <span class="comment">//下一个可用的数值索引,如:arr[] = 1;arr["a"] = 2;arr[] = 3;  则nNextFreeElement = 2;</span></span><br><span class="line">    <span class="keyword">dtor_func_t</span>       pDestructor;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>HashTable有两个非常相近的值：nNumUsed、nNumOfElements，nNumOfElements表示哈希表已有的元素数，nNumUsed表示已用的桶数？<strong>这两个值有什么不一样吗？</strong><br>实际上，它们有不同的含义，当将一个元素从哈希表删除时，并不会将对应的Bucket移除，而是将Bucket存储的zval修改为IS_UNDEF ， 只有扩容时发现nNumOfElements与nNumUsed相差达到一定数量（这个数量是 ht-&gt;nNumUsed - ht-&gt;nNumOfElements &gt; (ht-&gt;nNumOfElements &gt;&gt; 5)）时才会将已删除的元素全部移除，重新构建哈希表。所以nNumUsed &gt;= nNumOfElements</p>
<p>HashTable中另外一个非常重要的值arData，这个值指向存储元素数组的第一个Bucket,插入元素时按照顺序 <strong>依次插</strong>入 数组。 PHP数组的有序性正是通过arData保证的，这是第一个与普通散列表实现不同的地方。</p>
<p>既然arData并不是按key映射的散列表，那么映射函数是如何将key与arData中的value建立映射关系的呢？</p>
<p>实际上这个散列表也在arData中，比较特别的是散列表在ht-&gt;arData内存之前，分配内存时这个散列表与Bucket数组一起分配，arData向后移动到了Bucket数组的起始位置，并不是申请内存的起始位置，这样散列表可以由arData指针向前移动访问到，即arData[-1]、arData[-2]、arData[-3]……散列表的结构是uint32_t，它保存的是value在Bucket数组中的位置。</p>
<p>所以，整体来看HashTable主要依赖arData实现元素的存储、索引。插入一个元素时先将元素按先后顺序插入Bucket数组，位置是idx，再根据key的哈希值映射到散列表中的某个位置nIndex，将idx存入这个位置；查找时先在散列表中映射到nIndex，得到value在Bucket数组的位置idx，再从Bucket数组中取出元素。（&hearts;）</p>
<p>比如：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$arr[<span class="string">"a"</span>] = <span class="number">1</span>;</span><br><span class="line">$arr[<span class="string">"b"</span>] = <span class="number">2</span>;</span><br><span class="line">$arr[<span class="string">"c"</span>] = <span class="number">3</span>;</span><br><span class="line">$arr[<span class="string">"d"</span>] = <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unset</span>($arr[<span class="string">"c"</span>]);</span><br></pre></td></tr></table></figure></p>
<p>对应的HashTable如下图所示。<br><img src="http://image.huany.top/hexo/php/php-array-hashtable.png" alt></p>
<h3 id="2-映射函数"><a href="#2-映射函数" class="headerlink" title="2.映射函数"></a>2.映射函数</h3><p>映射函数是散列表的关键部分，它将key与value建立映射关系，一般映射函数可以将key的hash值与Bucket数组取模得到，即 key-&gt;h % ht-&gt;nTableSize,但是PHP并不是这么做的：</p>
<blockquote>
<p>nIndex = key-&gt;h | ht-&gt;nTableMask;</p>
</blockquote>
<p>显然位运算比取模运算更快。<br>nTableMask为nTableSize的负数，即: nTableMask = -nTableSize。因为nTableSize等于2^n，所以ntableMask二进制右侧全部为0，也就保证了nIndex落在数组索引的范围之内(|nIndex|&lt;=nTableSize).</p>
<pre><code>11111111 11111111 11111111 11111000   -8
11111111 11111111 11111111 11110000   -16
11111111 11111111 11111111 11100000   -32
11111111 11111111 11111111 11000000   -64
11111111 11111111 11111111 10000000   -128
</code></pre><h3 id="3-哈希碰撞"><a href="#3-哈希碰撞" class="headerlink" title="3.哈希碰撞"></a>3.哈希碰撞</h3><p>哈希碰撞是指不同的key可能计算得到相同的哈希值(数值索引的哈希值直接就是数值本身)，但是这些值又需要插入同一个散列表。一般解决方法是将Bucket串成链表，查找时遍历链表比较key。</p>
<p>PHP的实现也是如此，只是将链表的指针指向转化为了数值指向，即：指向冲突元素的指针并没有直接存在Bucket中，而是保存到了value的zval中：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">zval_struct</span> &#123;</span></span><br><span class="line">    zend_value        value;            <span class="comment">/* value */</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        <span class="keyword">uint32_t</span>     var_flags;</span><br><span class="line">        <span class="keyword">uint32_t</span>     next;                 <span class="comment">/* hash collision chain（哈希冲突链） */</span></span><br><span class="line">        <span class="keyword">uint32_t</span>     cache_slot;           <span class="comment">/* literal cache slot */</span></span><br><span class="line">        <span class="keyword">uint32_t</span>     lineno;               <span class="comment">/* line number (for ast nodes) */</span></span><br><span class="line">        <span class="keyword">uint32_t</span>     num_args;             <span class="comment">/* arguments number for EX(This) */</span></span><br><span class="line">        <span class="keyword">uint32_t</span>     fe_pos;               <span class="comment">/* foreach position */</span></span><br><span class="line">        <span class="keyword">uint32_t</span>     fe_iter_idx;          <span class="comment">/* foreach iterator index */</span></span><br><span class="line">    &#125; u2;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>当出现冲突时将原value的位置保存到新value的zval.u2.next中，然后将新插入的value的位置更新到散列表，也就是后面冲突的value始终插入header。所以查找过程类似：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">zend_ulong h = zend_string_hash_val(key);</span><br><span class="line"><span class="keyword">uint32_t</span> idx = ht-&gt;arHash[h &amp; ht-&gt;nTableMask];</span><br><span class="line"><span class="keyword">while</span> (idx != INVALID_IDX) &#123;</span><br><span class="line">    Bucket *b = &amp;ht-&gt;arData[idx];</span><br><span class="line">    <span class="keyword">if</span> (b-&gt;h == h &amp;&amp; zend_string_equals(b-&gt;key, key)) &#123;</span><br><span class="line">        <span class="keyword">return</span> b;</span><br><span class="line">    &#125;</span><br><span class="line">    idx = Z_NEXT(b-&gt;val); <span class="comment">//移到下一个冲突的value</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br></pre></td></tr></table></figure></p>
<h3 id="4-插入、查找、删除"><a href="#4-插入、查找、删除" class="headerlink" title="4.插入、查找、删除"></a>4.插入、查找、删除</h3><p>这几个基本操作比较简单，不再赘述，定位到元素所在Bucket位置后的操作类似单链表的插入、删除、查找。</p>
<h3 id="5-扩容"><a href="#5-扩容" class="headerlink" title="5.扩容"></a>5.扩容</h3><p>散列表可存储的value数是固定的，当空间不够用时就要进行扩容了。</p>
<p>PHP散列表的大小为2^n，插入时如果容量不够则首先检查已删除元素所占比例，如果达到阈值(ht-&gt;nNumUsed - ht-&gt;nNumOfElements &gt; (ht-&gt;nNumOfElements &gt;&gt; 5)，则将已删除元素移除，重建索引，如果未到阈值则进行扩容操作，扩大为当前大小的2倍，将当前Bucket数组复制到新的空间，然后重建索引。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//zend_hash.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> ZEND_FASTCALL <span class="title">zend_hash_do_resize</span><span class="params">(HashTable *ht)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ht-&gt;nNumUsed &gt; ht-&gt;nNumOfElements + (ht-&gt;nNumOfElements &gt;&gt; <span class="number">5</span>)) &#123;</span><br><span class="line">        <span class="comment">//只有到一定阈值才进行rehash操作</span></span><br><span class="line">        zend_hash_rehash(ht); <span class="comment">//重建索引数组</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ht-&gt;nTableSize &lt; HT_MAX_SIZE) &#123;</span><br><span class="line">        <span class="comment">//扩容</span></span><br><span class="line">        <span class="keyword">void</span> *new_data, *old_data = HT_GET_DATA_ADDR(ht);</span><br><span class="line">        <span class="comment">//扩大为2倍，加法要比乘法快，小的优化点无处不在...</span></span><br><span class="line">        <span class="keyword">uint32_t</span> nSize = ht-&gt;nTableSize + ht-&gt;nTableSize;</span><br><span class="line">        Bucket *old_buckets = ht-&gt;arData;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//新分配arData空间，大小为:(sizeof(Bucket) + sizeof(uint32_t)) * nSize</span></span><br><span class="line">        new_data = pemalloc(HT_SIZE_EX(nSize, -nSize), ...);</span><br><span class="line">        ht-&gt;nTableSize = nSize;</span><br><span class="line">        ht-&gt;nTableMask = -ht-&gt;nTableSize;</span><br><span class="line">        <span class="comment">//将arData指针偏移到Bucket数组起始位置</span></span><br><span class="line">        HT_SET_DATA_ADDR(ht, new_data);</span><br><span class="line">        <span class="comment">//将旧的Bucket数组拷到新空间</span></span><br><span class="line">        <span class="built_in">memcpy</span>(ht-&gt;arData, old_buckets, <span class="keyword">sizeof</span>(Bucket) * ht-&gt;nNumUsed);</span><br><span class="line">        <span class="comment">//释放旧空间</span></span><br><span class="line">        pefree(old_data, ht-&gt;u.flags &amp; HASH_FLAG_PERSISTENT);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//重建索引数组：散列表</span></span><br><span class="line">        zend_hash_rehash(ht);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HT_SET_DATA_ADDR(ht, ptr) do &#123; \</span></span><br><span class="line">        (ht)-&gt;arData = (Bucket*)(((<span class="keyword">char</span>*)(ptr)) + HT_HASH_SIZE((ht)-&gt;nTableMask)); \</span><br><span class="line">    &#125; <span class="keyword">while</span> (<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<h3 id="6-重建散列表"><a href="#6-重建散列表" class="headerlink" title="6.重建散列表"></a>6.重建散列表</h3><p>当删除元素达到一定数量或扩容后都需要重建散列表，因为value在Bucket位置移动了或哈希数组nTableSize变化了导致key与value的映射关系改变，重建过程实际就是遍历Bucket数组中的value，然后重新计算映射值更新到散列表，除了更新散列表之外，这里还有一个重要的处理：移除已删除的value，开始的时候我们说过，删除value时只是将value的type设置为IS_UNDEF，并没有实际从Bucket数组中删除，如果这些value一直存在那么将浪费很多空间，所以这里会把它们移除，操作的方式也比较简单：将后面未删除的value依次前移，具体过程如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//zend_hash.c</span></span><br><span class="line"><span class="function">ZEND_API <span class="keyword">int</span> ZEND_FASTCALL <span class="title">zend_hash_rehash</span><span class="params">(HashTable *ht)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Bucket *p;</span><br><span class="line">    <span class="keyword">uint32_t</span> nIndex, i;</span><br><span class="line">    ...</span><br><span class="line">    i = <span class="number">0</span>;</span><br><span class="line">    p = ht-&gt;arData;</span><br><span class="line">    <span class="keyword">if</span> (ht-&gt;nNumUsed == ht-&gt;nNumOfElements) &#123; <span class="comment">//没有已删除的直接遍历Bucket数组重新插入索引数组即可</span></span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            nIndex = p-&gt;h | ht-&gt;nTableMask;</span><br><span class="line">            Z_NEXT(p-&gt;val) = HT_HASH(ht, nIndex);</span><br><span class="line">            HT_HASH(ht, nIndex) = HT_IDX_TO_HASH(i);</span><br><span class="line">            p++;</span><br><span class="line">        &#125; <span class="keyword">while</span> (++i &lt; ht-&gt;nNumUsed);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (UNEXPECTED(Z_TYPE(p-&gt;val) == IS_UNDEF)) &#123;</span><br><span class="line">                <span class="comment">//有已删除元素则将后面的value依次前移，压实Bucket数组</span></span><br><span class="line">                ......</span><br><span class="line">                <span class="keyword">while</span> (++i &lt; ht-&gt;nNumUsed) &#123;</span><br><span class="line">                    p++;</span><br><span class="line">                    <span class="keyword">if</span> (EXPECTED(Z_TYPE_INFO(p-&gt;val) != IS_UNDEF)) &#123;</span><br><span class="line">                        ZVAL_COPY_VALUE(&amp;q-&gt;val, &amp;p-&gt;val);</span><br><span class="line">                        q-&gt;h = p-&gt;h;</span><br><span class="line">                        nIndex = q-&gt;h | ht-&gt;nTableMask;</span><br><span class="line">                        q-&gt;key = p-&gt;key;</span><br><span class="line">                        Z_NEXT(q-&gt;val) = HT_HASH(ht, nIndex);</span><br><span class="line">                        HT_HASH(ht, nIndex) = HT_IDX_TO_HASH(j);</span><br><span class="line">                        <span class="keyword">if</span> (UNEXPECTED(ht-&gt;nInternalPointer == i)) &#123;</span><br><span class="line">                            ht-&gt;nInternalPointer = j;</span><br><span class="line">                        &#125;</span><br><span class="line">                        q++;</span><br><span class="line">                        j++;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                ......</span><br><span class="line">                ht-&gt;nNumUsed = j;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            nIndex = p-&gt;h | ht-&gt;nTableMask;</span><br><span class="line">            Z_NEXT(p-&gt;val) = HT_HASH(ht, nIndex);</span><br><span class="line">            HT_HASH(ht, nIndex) = HT_IDX_TO_HASH(i);</span><br><span class="line">            p++;</span><br><span class="line">        &#125;<span class="keyword">while</span>(++i &lt; ht-&gt;nNumUsed);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://meichaofan.github.io/2019/07/13/php-array/" data-id="ckghavx2k002hbad86gbo6zlv" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/php/">php</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/">C</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CSRF/">CSRF</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Desktop/">Desktop</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DevOps/">DevOps</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/">Docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Go/">Go</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Makefile/">Makefile</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP/">PHP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/">Redis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/algorithm/">algorithm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/c/">c</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cli/">cli</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go/">go</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/http/">http</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/image/">image</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/k8s/">k8s</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/leetcode/">leetcode</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/life/">life</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/numpy/">numpy</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/overlay2/">overlay2</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/overlayFs/">overlayFs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/php/">php</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/printf/">printf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/runC/">runC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/runlevel/">runlevel</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/samba/">samba</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ubuntu/">ubuntu</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/valgrind/">valgrind</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web安全/">web安全</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/倒排索引/">倒排索引</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/容器/">容器</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/C/" style="font-size: 16.67px;">C</a> <a href="/tags/CSRF/" style="font-size: 10px;">CSRF</a> <a href="/tags/Desktop/" style="font-size: 10px;">Desktop</a> <a href="/tags/DevOps/" style="font-size: 10px;">DevOps</a> <a href="/tags/Docker/" style="font-size: 10px;">Docker</a> <a href="/tags/Go/" style="font-size: 10px;">Go</a> <a href="/tags/Linux/" style="font-size: 10px;">Linux</a> <a href="/tags/Makefile/" style="font-size: 10px;">Makefile</a> <a href="/tags/PHP/" style="font-size: 11.67px;">PHP</a> <a href="/tags/Redis/" style="font-size: 10px;">Redis</a> <a href="/tags/algorithm/" style="font-size: 10px;">algorithm</a> <a href="/tags/c/" style="font-size: 11.67px;">c</a> <a href="/tags/cli/" style="font-size: 10px;">cli</a> <a href="/tags/docker/" style="font-size: 18.33px;">docker</a> <a href="/tags/go/" style="font-size: 20px;">go</a> <a href="/tags/http/" style="font-size: 10px;">http</a> <a href="/tags/image/" style="font-size: 10px;">image</a> <a href="/tags/k8s/" style="font-size: 10px;">k8s</a> <a href="/tags/leetcode/" style="font-size: 10px;">leetcode</a> <a href="/tags/life/" style="font-size: 11.67px;">life</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/numpy/" style="font-size: 10px;">numpy</a> <a href="/tags/overlay2/" style="font-size: 10px;">overlay2</a> <a href="/tags/overlayFs/" style="font-size: 10px;">overlayFs</a> <a href="/tags/php/" style="font-size: 10px;">php</a> <a href="/tags/printf/" style="font-size: 10px;">printf</a> <a href="/tags/python/" style="font-size: 10px;">python</a> <a href="/tags/runC/" style="font-size: 10px;">runC</a> <a href="/tags/runlevel/" style="font-size: 10px;">runlevel</a> <a href="/tags/samba/" style="font-size: 10px;">samba</a> <a href="/tags/ubuntu/" style="font-size: 13.33px;">ubuntu</a> <a href="/tags/valgrind/" style="font-size: 10px;">valgrind</a> <a href="/tags/web安全/" style="font-size: 10px;">web安全</a> <a href="/tags/倒排索引/" style="font-size: 10px;">倒排索引</a> <a href="/tags/容器/" style="font-size: 10px;">容器</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/08/26/install-k8s/">利用kubeadm安装k8s</a>
          </li>
        
          <li>
            <a href="/2019/08/02/linux-json-format/">linux下json解析神器 - jq</a>
          </li>
        
          <li>
            <a href="/2019/08/01/printf-console-color/">设定printf在终端输出字体的颜色</a>
          </li>
        
          <li>
            <a href="/2019/07/31/clion-create-multi-project/">clion建立多级工作目录</a>
          </li>
        
          <li>
            <a href="/2019/07/26/sword-finger-offer-3-1/">剑指Offer - 3.1 - 数组中重复的数字</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 meichaofan<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/categories" class="mobile-nav-link">Categories</a>
  
    <a href="/categories/tec" class="mobile-nav-link">Tec</a>
  
    <a href="/categories/read-note" class="mobile-nav-link">ReadNote</a>
  
    <a href="/categories/life" class="mobile-nav-link">Life</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>